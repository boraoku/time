<!DOCTYPE html>
<html>
<head>
    <title>Debug Time Parser</title>
    <style>
        body {
            font-family: monospace;
            padding: 20px;
            background: #1a1a1a;
            color: #00ff66;
            line-height: 1.6;
        }
        .step {
            margin: 15px 0;
            padding: 15px;
            border-left: 3px solid #00ff66;
            background: rgba(0, 255, 100, 0.05);
        }
        .step-title {
            color: #88ff00;
            font-weight: bold;
            margin-bottom: 10px;
        }
        .value {
            color: #66ffff;
            font-weight: bold;
        }
        .error {
            color: #ff6666;
            font-weight: bold;
        }
        pre {
            background: rgba(0, 0, 0, 0.5);
            padding: 10px;
            border-radius: 4px;
            overflow-x: auto;
        }
    </style>
</head>
<body>
    <h1>üîç TimeParser Debug - Step by Step</h1>
    <div id="output"></div>

    <script type="module">
        import { CITY_TIMEZONE_MAP } from './js/data/cityTimezoneMap.js';

        const output = document.getElementById('output');

        function addStep(title, content) {
            const step = document.createElement('div');
            step.className = 'step';
            step.innerHTML = `<div class="step-title">${title}</div>${content}`;
            output.appendChild(step);
        }

        function debugParse() {
            const input = "3:30pm new york in tokyo, paris";

            addStep('INPUT', `Query: <span class="value">"${input}"</span>`);

            // Step 1: Split by " in "
            const parts = input.split(/\s+in\s+/);
            addStep('STEP 1: Split by " in "', `
                Source part: <span class="value">"${parts[0]}"</span><br>
                Target part: <span class="value">"${parts[1]}"</span>
            `);

            // Step 2: Parse source (time + city)
            let sourcePart = parts[0];
            const timeMatch = sourcePart.match(/(\d{1,2}):?(\d{2})?\s*(am|pm)?/i);

            addStep('STEP 2: Parse time from source', `
                Regex match: <span class="value">${JSON.stringify(timeMatch)}</span><br>
                Hour: <span class="value">${timeMatch[1]}</span><br>
                Minute: <span class="value">${timeMatch[2] || '0'}</span><br>
                Meridiem: <span class="value">${timeMatch[3]}</span>
            `);

            let hour = parseInt(timeMatch[1]);
            const minute = parseInt(timeMatch[2] || '0');
            const meridiem = timeMatch[3] ? timeMatch[3].toLowerCase() : null;

            // Convert to 24-hour
            if (meridiem === 'pm' && hour !== 12) {
                hour += 12;
            } else if (meridiem === 'am' && hour === 12) {
                hour = 0;
            }

            addStep('STEP 3: Convert to 24-hour format', `
                Original hour: <span class="value">${timeMatch[1]}</span><br>
                24-hour format: <span class="value">${hour}:${minute.toString().padStart(2, '0')}</span>
            `);

            // Extract city
            const cityPart = sourcePart.replace(timeMatch[0], '').trim();
            const sourceCity = cityPart || 'utc';

            addStep('STEP 4: Extract source city', `
                City: <span class="value">"${sourceCity}"</span><br>
                Timezone: <span class="value">"${CITY_TIMEZONE_MAP[sourceCity]}"</span>
            `);

            // Create Date (THIS IS WHERE THE BUG IS!)
            const now = new Date();
            const sourceTime = new Date(now.getFullYear(), now.getMonth(), now.getDate(), hour, minute, 0, 0);

            addStep('‚ö†Ô∏è  STEP 5: Create Date object (BUGGY!)', `
                <span class="error">PROBLEM: new Date(year, month, day, hour, minute) creates a Date in the BROWSER's timezone!</span><br>
                <br>
                Created Date: <span class="value">${sourceTime}</span><br>
                UTC representation: <span class="value">${sourceTime.toUTCString()}</span><br>
                Browser timezone offset: <span class="value">${-sourceTime.getTimezoneOffset()} minutes</span><br>
                <br>
                What we WANTED: <span class="value">3:30 PM New York time</span><br>
                What we GOT: <span class="value">3:30 PM ${Intl.DateTimeFormat().resolvedOptions().timeZone} time</span><br>
                <br>
                Formatted as New York time: <span class="value">${sourceTime.toLocaleString('en-US', { timeZone: 'America/New_York', hour: '2-digit', minute: '2-digit', hour12: true })}</span><br>
                <span class="error">^ This is WRONG! It should be 3:30 PM, not whatever it shows!</span>
            `);

            // Show what convertToTimezone does
            const sourceTimezone = CITY_TIMEZONE_MAP[sourceCity];
            const targetTimezone = CITY_TIMEZONE_MAP['tokyo'];

            addStep('STEP 6: convertToTimezone() method', `
                Source timezone: <span class="value">${sourceTimezone}</span><br>
                Target timezone: <span class="value">${targetTimezone}</span><br>
                <br>
                Current method tries to format the already-wrong Date:<br>
                <pre>const targetString = sourceDate.toLocaleString('en-US', {
    timeZone: targetTimezone,
    ...
});</pre>
                <br>
                But sourceDate was created in <span class="error">BROWSER timezone</span>, not New York!<br>
                So all subsequent conversions are wrong.
            `);

            // Show correct approach
            addStep('‚úÖ CORRECT APPROACH', `
                We need to:<br>
                1. Parse the hour/minute (15:30)<br>
                2. Get New York's UTC offset (e.g., -5 for EST)<br>
                3. Create a Date representing "3:30 PM New York" in UTC<br>
                4. Then convert that UTC time to other timezones<br>
                <br>
                Example:<br>
                - 3:30 PM EST (UTC-5) = 8:30 PM UTC<br>
                - Create: <span class="value">new Date(Date.UTC(year, month, day, 20, 30, 0))</span><br>
                - Then format this UTC date in Tokyo timezone<br>
                - 8:30 PM UTC = 5:30 AM JST (next day) ‚úì
            `);

            // Demonstrate the fix
            demonstrateFix();
        }

        function demonstrateFix() {
            addStep('üîß DEMONSTRATION OF FIX', '');

            const hour = 15; // 3 PM
            const minute = 30;
            const sourceTimezone = 'America/New_York';

            // Get current date in source timezone
            const now = new Date();
            const sourceDateString = now.toLocaleString('en-US', {
                timeZone: sourceTimezone,
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                timeZoneName: 'longOffset'
            });

            addStep('Get source timezone info', `
                Current time in New York: <span class="value">${sourceDateString}</span>
            `);

            // Extract offset
            const offsetMatch = sourceDateString.match(/GMT([+-])(\d{1,2}):?(\d{2})?/);
            if (offsetMatch) {
                const sign = offsetMatch[1] === '+' ? 1 : -1;
                const offsetHours = parseInt(offsetMatch[2]);
                const offsetMinutes = parseInt(offsetMatch[3] || '0');
                const totalOffsetHours = sign * (offsetHours + offsetMinutes / 60);

                addStep('Extract timezone offset', `
                    Offset string: <span class="value">${offsetMatch[0]}</span><br>
                    Offset hours: <span class="value">${totalOffsetHours}</span>
                `);

                // Calculate UTC time
                const utcHour = hour - totalOffsetHours;

                addStep('Calculate UTC equivalent', `
                    Source time: <span class="value">${hour}:${minute.toString().padStart(2, '0')} (New York)</span><br>
                    UTC offset: <span class="value">${totalOffsetHours} hours</span><br>
                    UTC time: <span class="value">${utcHour}:${minute.toString().padStart(2, '0')}</span>
                `);

                // Create correct Date in UTC
                const [monthStr, dayStr, yearStr] = now.toLocaleDateString('en-US', { timeZone: sourceTimezone }).split('/');
                const correctDate = new Date(Date.UTC(
                    parseInt(yearStr),
                    parseInt(monthStr) - 1,
                    parseInt(dayStr),
                    utcHour,
                    minute,
                    0
                ));

                addStep('Create correct Date object', `
                    UTC Date: <span class="value">${correctDate.toUTCString()}</span>
                `);

                addStep('‚úÖ VERIFY CONVERSIONS', `
                    New York: <span class="value">${correctDate.toLocaleString('en-US', { timeZone: 'America/New_York', hour: '2-digit', minute: '2-digit', hour12: true })}</span> ‚úì<br>
                    Tokyo: <span class="value">${correctDate.toLocaleString('en-US', { timeZone: 'Asia/Tokyo', hour: '2-digit', minute: '2-digit', hour12: true })}</span><br>
                    Paris: <span class="value">${correctDate.toLocaleString('en-US', { timeZone: 'Europe/Paris', hour: '2-digit', minute: '2-digit', hour12: true })}</span>
                `);
            }
        }

        // Run debug
        debugParse();
    </script>
</body>
</html>
